<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<style type="text/css">
		.overlay {
			background-color: #FFF;
		}

		#fcaHead {
			font-size: 28px;
			color: blue;
		}

		.node circle {
			fill: #fff;
			stroke: steelblue;
			stroke-width: 1.5px;
		}

		.node text {
			font-size: 10px;
			font-family: sans-serif;
		}

		.link {
			fill: none;
			stroke: #ccc;
			stroke-width: 1.5px;
		}

		.selected {
			color: orange;
		}

		.hint {
			float: right;
			color: blue;
			margin-right: 80px;
			font-style: oblique;
		}

		.node {
			cursor: pointer;
			position: absolute;
			list-style: none;
			font-size: 14px;
		}

		.node span {
			margin-right: 3px;
		}

		span {
			white-space: nowrap;
		}
	</style>

	<link
			href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"
			rel="stylesheet">

	<link rel="shortcut icon" href="favicon.ico">
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width">

	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script type="text/javascript" src="js/popluateAttributeDropdown.js" defer></script>
	<script type="text/javascript" src="js/pruneUsingAttribute.js" defer></script>
	<script type="text/javascript" src="js/treelist.js" defer></script>
	<script type="text/javascript" src="js/drawFileTree.js" defer></script>
	<script type="text/javascript" src="js/drawDendrogram.js" defer></script>
	<script type="text/javascript" src="js/drawVerticalDendrogram.js" defer></script>

	<title>FCA Tree Tool</title>
</head>

<body>
<div>
	<span id="fcaHead">FCA Tree Tool  &nbsp; &nbsp; &nbsp; </span>
	<span> 1. Select a valid JSON file:  <input type="file" id="files"/> </span>

	Display type:
	<select id="treeType">
		<option value="dendrogram">dendrogram</option>
		<option value="list">expandable list</option>
		<option value="verticalDendrogram">vertical dendrogram</option>
	</select>
	<button id="upload">Upload and Process File</button> &nbsp;
</div>

<div id="line2">

<span id="viewoptions"> &nbsp; Options:
		Attributes: <input type="checkbox" id="attributes" name="attributes">
		Objects: <input type="checkbox" id="objects"  name="objects">
       &nbsp;Object Count: <input type="checkbox" id="objectCount" name="objectCount">
	</span>
	<span id=attSelectSpan>
    		Restrict to nodes with attribute for node or descendent node:
		<select id="attributeDropdown" name="attributeDropdown">
			<option>none</option>
		</select>

	</span>
	<button id="drawT">2. Draw Tree</button>
	<span class="hint" id="dendHint"> Mouse wheel to zoom. Hold
		click and move mouse to move tree </span>
	</span> <span class="hint" id="verticalHint"> Mouse over node to see
			attribute and object information </span>
</div>

<div id="tree-container"></div>

<script>

	function populateAttributeDropdown(attributeSet) {

		const attributes = Array.from(attributeSet);

		console.log(" att 2 " + attributes[2]);

		$("#attributeDropdown").remove();

		var selectFragment = document.createDocumentFragment();
		var selectEl = document.createElement('select');
		selectEl.id = 'attributeDropdown';
		selectFragment.append(selectEl);

		var selSpan = document.getElementById('attSelectSpan');
		selSpan.appendChild(selectFragment);

		var selAttributeDropdown = document.getElementById('attributeDropdown');
		var optionsFragment = document.createDocumentFragment();

		var opt0 = document.createElement('option');
		opt0.text = "none";
		optionsFragment.appendChild(opt0);

		attributes.forEach(function (att, index) {
			const opt = document.createElement('option');
			// console.log ("att is " + att + " index " + index);
			opt.innerHTML = att;
			opt.value = att;
			opt.text = att;
			opt.index = index;
			opt.innerText = att;

			optionsFragment.appendChild(opt);
		});

		selAttributeDropdown.appendChild(optionsFragment);

		$("#attSelectSpan").show();
	}

	$(document).ready(function () {
		$("#files").change(function(){
			$("#line2").hide();

		});

		$("#attSelectSpan").hide();
		$("#viewoptions").show();
		$("#dendHint").hide();
		$("#verticalHint").hide();
		$("#line2").hide();

		$('#objects').val(this.checked);

		$("select#treeType").on('change', function () {

			if ($("#treeType").val() == "verticalDendrogram") {
				$("#viewoptions").hide();
			} else {
				$("#viewoptions").show();
			}

			if ($("#treeType").val() == "list") {
				$(".hint").hide();
			} else {
				$(".hint").show();
			}
		});

		$("#attributeDropdown").change(function () {
			reload(false);
		});

		$(':checkbox').change(function () {
			reload(false);
		});
	});

	const fileInput = $('#files');
	const uploadButton = $('#upload');
	const drawButton = $('#drawT')

	function setAtts(e) {

		const jsonFile = e.target.result;
		const treeData = JSON.parse(jsonFile);
		const a = getSetOfAttributes(treeData, new Set());

		console.log(" a " + a);
		populateAttributeDropdown(a);

	}

	function reload(uploadNewFile) {

		if (!window.FileReader) {
			alert('Your browser is not supported')
		}
		let input = fileInput.get(0);
		console.log("in reoload");
		$("#line2").show();
		// Create a reader object
		const reader = new FileReader();
		if (input.files.length) {
			var textFile = input.files[0];
			reader.readAsText(textFile);
			$(reader).on('load', setAtts);
		}
	}

	function drawT() {

		var input;
		if (!window.FileReader) {
			alert('Your browser is not supported')
		}
		input = fileInput.get(0);

		// Create a reader object
		var reader = new FileReader();
		if (input.files.length) {
			var textFile = input.files[0];
			reader.readAsText(textFile);

			if ($("#treeType").val() == "list") {
				$(reader).on('load', drawFileTree);
			} else if ($("#treeType").val() == "verticalDendrogram") {
				$(reader).on('load', drawVerticalDendrogram);

			} else {

				$(reader).on('load', drawDendrogram);
			}
		} else {
			if (uploadNewFile)
				alert('Please select a valid json file before continuing')
		}
	};

	uploadButton.on('click', reload);
	drawButton.on('click', drawT);

</script>
</body>
</html>