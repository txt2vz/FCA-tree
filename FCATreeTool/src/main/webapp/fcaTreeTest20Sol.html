<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style type="text/css">
        .overlay {
            background-color: #FFF;
        }

        #fcaHead {
            font-size: 28px;
            color: blue;
        }

        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 1.5px;
        }

        .node text {
            font-size: 10px;
            font-family: sans-serif;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

        .selected {
            color: orange;
        }

        .hint {
            float: right;
            color: blue;
            margin-right: 80px;
            font-style: oblique;
        }

        .node {
            cursor: pointer;
            position: absolute;
            list-style: none;
            font-size: 14px;
        }

        .node span {
            margin-right: 3px;
        }

        span {
            white-space: nowrap;
        }
    </style>

    <link
            href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"
            rel="stylesheet">

    <link rel="shortcut icon" href="favicon.ico">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="js/popluateAttributeDropdown.js" defer></script>
    <script type="text/javascript" src="js/pruneUsingAttribute.js" defer></script>
    <script type="text/javascript" src="js/treelist.js" defer></script>
    <script type="text/javascript" src="js/drawFileTree.js" defer></script>
    <script type="text/javascript" src="js/drawDendrogram.js" defer></script>
    <script type="text/javascript" src="js/drawVerticalDendrogram.js" defer></script>

    <title>FCA Tree Tool</title>
</head>

<body>
<span id="fcaHead">FCA Tree Tool  &nbsp; &nbsp; &nbsp; </span>

<span id=attSelectSpan >
		Restrict to nodes with attribute for node or descendent node:
		<select id="attributeDropdown" name = "attributeDropdown">
			<option>none</option>
		</select>
	</span>
<br>

1. Select display type:
<select id="treeType">

    <option value="dendrogram">dendrogram</option>
    <option value="list">expandable list</option>
    <option value="verticalDendrogram">vertical dendrogram</option>
</select>
<span id="viewoptions"> &nbsp; &nbsp; &nbsp; &nbsp; Options (change forces refresh):
		Attributes <input type="checkbox" id="attributes" name="attributes">
		&nbsp; &nbsp; Objects: <input type="checkbox" id="objects"
                       name="objects"> &nbsp; Object Count: <input type="checkbox"
                       id="objectCount" name="objectCount">
	</span>

<span class="hint" id="dendHint"> Mouse wheel to zoom. Hold
		click and move mouse to move tree </span>

<div>
		<span> 2. Select a valid JSON file and upload/draw: <input
                type="file" id="files"/>
			<button id="upload"> Upload and Process File</button>  <button id="drawT">Draw Tree</button>
		</span> <span class="hint" id="verticalHint"> Mouse over node to see
			attribute and object information </span>
</div>

<div id="tree-container"></div>

<script>

    function populateAttributeDropdown(attributeSet) {
    //    $('#attributeDropdown').children('option:not(:first)').remove();
     //   $("select[name ='attributeDropdown']").children('option:not(:first)').remove();
       // $("select[name ='attributeDropdown']").append('<option>none</option>');
       // $('#attributeDropdown').children().remove();

     //    var x = document.getElementById("attributeDropdown");
        // for (i=1; i<x.length; i++) {
        //     console.log("removing i " + i);
        //     x.remove(i);
        // }
     //   $('select').children('option:not(:first)').remove();
      //  x.length=0;


     //   console.log("attribute set size " + attributeSet.size);
//
//        let zog =["none", "breast feeds", "cn"];
        var attributes = //zog;
            Array.from(attributeSet);

        console.log(" att 2 " + attributes[2]);

       // var attSelectDropDown = document.getElementById('attributeDropdown');
        $("#attributeDropdown").remove();


        var fragment = document.createDocumentFragment();
        var selectEl = document.createElement('select');
        selectEl.id='attributeDropdown';
        fragment.append(selectEl);
        var sel = document.getElementById('attSelectSpan');
        sel.appendChild(fragment);

        var sel2 = document.getElementById('attributeDropdown');
        var fragment2 = document.createDocumentFragment();

         var opt0 = document.createElement('option');
         opt0.text="none";
         fragment2.appendChild(opt0);

        //
        attributes.forEach(function(att, index) {
            var opt = document.createElement('option');
            console.log ("att is " + att + " index " + index);
            opt.innerHTML = att;
            opt.value = att;
            opt.text = att;
            opt.index= index;
            opt.innerText=att;

            fragment2.appendChild(opt);
        });


        sel2.appendChild(fragment2);


        $("#attSelectSpan").show();
    }

    $(document).ready(function () {

     //   location.reload();

        $("#attSelectSpan").hide();
        $("#viewoptions").show();
        $("#dendHint").hide();
        $("#verticalHint").hide();

        $('#objects').val(this.checked);

        $("select#treeType").on('change', function () {

            if ($("#treeType").val() == "verticalDendrogram") {
                $("#viewoptions").hide();
            } else {
                $("#viewoptions").show();
            }

            if ($("#treeType").val() == "list") {
                $(".hint").hide();
            } else {
                $(".hint").show();
            }
        });

        $("#attributeDropdown").change(function () {
            reload(false);
        });

        $(':checkbox').change(function () {
            reload(false);
        });

    });

    var fileInput = $('#files');
    var uploadButton = $('#upload');
    var drawButton = $('#drawT')
    var first = true;

    function setAtts(e){

        var jsonFile = e.target.result;
        var treeData = JSON.parse(jsonFile);
        let a= getSetOfAttributes(treeData, new Set());

        console.log(" a " + a);
        populateAttributeDropdown(a);
    }

    function reload(uploadNewFile) {

        var input;
        if (!window.FileReader) {
            alert('Your browser is not supported')
        }
        input = fileInput.get(0);

        // Create a reader object
        var reader = new FileReader();
        if (input.files.length) {
            var textFile = input.files[0];
            reader.readAsText(textFile);
                      $(reader).on('load', setAtts);

    }}

    function drawT() {

        var input;
        if (!window.FileReader) {
            alert('Your browser is not supported')
        }
        input = fileInput.get(0);

        // Create a reader object
        var reader = new FileReader();
        if (input.files.length) {
            var textFile = input.files[0];
            reader.readAsText(textFile);

            if ($("#treeType").val() == "list") {
                $(reader).on('load', drawFileTree);
            } else if ($("#treeType").val() == "verticalDendrogram") {
                $(reader).on('load', drawVerticalDendrogram);

            } else {
                // if (first) {
                //     $(reader).on('load', setAtts);
                //     //   first = false;
                // }
                $(reader).on('load', drawDendrogram);
            }
        } else {
            if (uploadNewFile)
                alert('Please select a valid json file before continuing')
        }
    };

    uploadButton.on('click', reload);
    drawButton.on('click', drawT);

</script>
</body>
</html>